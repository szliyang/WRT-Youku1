<!doctype html>
<html>
<head>
<meta charset="utf-8">
<title>优酷土豆路由宝</title>
<link rel="stylesheet" type="text/css" href="extend/css/hefot.css?ver=20160121">
<link rel="stylesheet" type="text/css" href="css/reset.css?ver=20160121">
<link rel="stylesheet" type="text/css" href="css/popup.css?ver=20160121">
<link rel="stylesheet" type="text/css" href="css/tab.css?ver=20160121">
<link rel="stylesheet" type="text/css" href="css/widget.css?ver=20160121">
<link rel="stylesheet" type="text/css" href="css/networkset.css?ver=20160121">
<script type="text/javascript" charset="utf-8"  src="js/jquery.min.js?ver=20160121"></script>
<script type="text/javascript" charset="utf-8"  src="js/jquery.form.js?ver=20160121"></script>
<script type="text/javascript" charset="utf-8"  src="js/jquery.base64.js?ver=20160121"></script>
<script type="text/javascript" charset="utf-8"  src="js/jquery.cookie.js?ver=20160121"></script>
<script type="text/javascript" charset="utf-8"  src="js/jquery.tabs.js?ver=20160121"></script>
<script type="text/javascript" charset="utf-8"  src="js/json2.js?ver=20160121"></script>
<script type="text/javascript" charset="utf-8"  src="js/public.js?ver=20160121"></script>
<script type="text/javascript" charset="utf-8"  src="js/validate.js?ver=20160121"></script>
<script type="text/javascript" charset="utf-8"  src="js/nodeClick.js?ver=20160121"></script>
<script type="text/javascript" charset="utf-8"  src="js/popup.js?ver=20160121"></script>
<script type="text/javascript" charset="utf-8"  src="js/doT.js?ver=20160121"></script>
<script type="text/javascript" charset="utf-8"  src="extend/js/common.js?ver=20160121"></script>
<script src="js/jquery.tabs.js?ver=20160121"></script>
<script type="text/javascript" charset="utf-8"  src="js/upgrade.js?ver=20160121"></script>
</head>
<body>
<div class="header_body" style="min-width: 1000px;">
    <div class="logo"></div>
    <div class="nav">
       <ul class="nav_top" id="topmenu">
        <li><a href="##" dataurl="dashboard.html" class="topmenu">首页</a></li>
        <li><a href="##" dataurl="wan.html" class="topmenu">连网设置</a></li>
        <li><a href="##" dataurl="wireless.html" class="topmenu">Wi-Fi设置</a></li>
        <li class="current"><a href="##" dataurl="device.html" class="topmenu current">设备管理</a></li>
        <li><a href="##" dataurl="advanced_setting.html" class="topmenu">更多设置</a></li>
       </ul>
    </div>
    <div class="nav_right"></div>
</div>
 <div class="box">
      <div class="lian_jie"><span id="devConnNowNum"></span><span id="devConnNowRef">台设备已连接路由宝</span><a href="#" id="refresh" class="refresh"></a><span id="devConnNowRef1" style="margin-left:10px;display:none;">载入中...</span></div>
       <div class="hei" style="display:none;">
          <span class="black_dan black_gray" id="addblackbtn">+黑名单</span>
          <span class="whiher_dan black_gray" id="addwhitebtn">+白名单</span>
          <a href="##" class="ed"></a>
          
      </div>
	  <script type="text/template" id="currentDevListTemplate">
      <table class="biaoge clearfix" cellspacing="0" cellpadding="0" id="orderedlist">
         <tr ><th class="t1">设备</th><th class="t2">IP与MAC地址</th><th class="t3">网速 KB/s(1KB/s = 8Kbps)</th><th class="t4">连接方式</th><th class="t5">访问互联网</th></tr>
         
		 {{ for (var i = 0,l = it.data.length;i < l;i++) { }}
		 {{if(it.data[i].accept=="yes") { }}   
		     <tr class="Normal">
		 {{ } else { }}
		     <tr class="zhuihui_ash">
		 {{ } }}
             <td>
			 {{if(it.data[i].contype=="lan") { }}
                <div class="check_unable"></div>
             {{ } else if(it.data[i].contype=="wifi") { }}
                <div class="check_ed bwcheckbox" data-query="{{=it.data[i].name}}|||{{=it.data[i].mac}}"></div>
             {{ } }}
              
                <div class="w1">
                    <div class="fang">
                      <img src="images/cn/{{=it.data[i].deviceicon}}">
					</div>
                    <div class="w1_con">
                        <div class="colu">
                           <span class="text_wenzi">{{=it.data[i].aliname}}</span>
                           <div class="feifazi" style="display:none;"><i>最多可输入20个字符</i></div>
                           <input type="text" class="bian_ji" value="{{=it.data[i].name}}" style="display:none;"/> 
							 {{if(it.data[i].accept=="yes") { }}   
								  <a href="##" class="kebianji editname"></a>
							 {{ } else { }}
								  <a href="##" class="kebianji editname" style="display:none;"></a>
							 {{ } }}
                           <a href="##" class="que_ding editok" data-query="{{=it.data[i].mac}}" style="display:none;">确定</a>
                        </div>
                        
                    </div>
                </div> 
             </td>
             <td>
                 <div class="ip_configure">
				    <div class="ip_Address">{{=it.data[i].ip}}</div>
                    <div class="Mac_Address">
                        <div class="mac_Name">{{=it.data[i].mac}}</div>
                        <div class="mac_Modify">
						    {{if(it.data[i].isbinded=="yes") { }} 
							   {{if(it.data[i].accept=="yes") { }}   
								  <div class="Binding">
                                    <span class="Already">已绑定</span>
                                    <a href="##" class="Relieve" data-query="{{=it.data[i].name}}|||{{=it.data[i].mac}}|||{{=it.data[i].ip}}">解除</a>
                                  </div>
							   {{ } else { }}
								  <div class="Binding" style="display:none;">
                                    <span class="Already">已绑定</span>
                                    <a href="##" class="Relieve" data-query="{{=it.data[i].name}}|||{{=it.data[i].mac}}|||{{=it.data[i].ip}}">解除</a>
                                  </div>
							   {{ } }}
							{{ } else if(it.data[i].isbinded=="none") { }}
							   {{if(it.data[i].accept=="yes") { }}   
								  <div class="Unbundling" id="Unbundling" data-query="{{=it.data[i].name}}|||{{=it.data[i].mac}}|||{{=it.data[i].ip}}">MAC地址绑定</div>
							   {{ } else { }}
								  <div class="Unbundling" style="display:none;" id="Unbundling" data-query="{{=it.data[i].name}}|||{{=it.data[i].mac}}|||{{=it.data[i].ip}}">MAC地址绑定</div>
							   {{ } }}  
							{{ } }}
                        </div>
                    </div>
                 </div>
             </td>
             <td>
               <div class="w3">
                   <span class="Upstream"><b>↑</b> {{=it.data[i].up_rate}}</span>
                   <!--div class="xiansu xianshu_zhi">
                       <b>↑</b>
                       <span class="xian_su">限速</span>
                        <div class="feifazi"><i>含非法字符请重新输入</i></div>
                       <input type="text" class="qu_ding"/>
                       <span class="xian_ding">限速<strong>960</strong></span>
                       <a href="##" class="shan_qu">确定</a>
                        <a href="##" class="jiebang">解除</a>
                   </div-->
               </div>
               <div class="w3 w4">
                   <span class="Upstream"><b>↓</b> {{=it.data[i].down_rate}}</span>
                   <!--div class="xiansu">
                       <b>↓</b>
                       <span class="xian_su">限速</span>
                       <div class="feifazi"><i>含非法字符请重新输入</i></div>
                       <input type="text" class="qu_ding"/>
                       <span class="xian_ding">限速<strong>960</strong></span>
                       <a href="##" class="shan_qu">确定</a>
                        <a href="##" class="jiebang">解除</a>
                   </div-->
               </div>
             </td>
             <td class="youxian">
                 {{if(it.data[i].contype=="lan") { }}
                       有线
                 {{ } else if(it.data[i].contype=="wifi") { }}
					Wi-Fi<br>
					{{=it.data[i].wifimode}}
                 {{ } }}
             </td>
             <td class="td_bornone">
			     {{if(it.data[i].accept=="yes") { }}   
					 <div class="accept closed" data-query="{{=it.data[i].name}}|||{{=it.data[i].mac}}|||{{=it.data[i].ip}}"></div> 
				 {{ } else { }}
					 <div class="accept guanbi" data-query="{{=it.data[i].name}}|||{{=it.data[i].mac}}|||{{=it.data[i].ip}}"></div> 
				 {{ } }}
             </td>
         </tr>
		 
		{{ } }}
        </table>
	</script>
    <div id="devCurrentList"></div>
    <div class="fangceng" style="display:none;">
        <span>无线访问控制（防蹭网）</span>
        <p class="guan_close closre"></p>
    </div>
    <div class="cengwang" id="cengwangPanel" style="display:none;">
        <div class="black_moshi">
            <div class="mingdan_left">
                <div class="whier">
                    <p class="rad-btn radio" id="blackmoderadio">黑名单模式</p>
                    <b>禁止下列设备接入Wi-Fi</b>
                </div>
                 <div class="black_da">
                    <p class="rad-btn" id="whitemoderadio">白名单模式</p>
                    <b>只允许下列设备接入Wi-Fi</b>
                </div>
            </div>
            <div class="mingdan_right">
			    <a href="##" class="qingkong">清空</a>
                <a href="##" class="shoudong">手动添加</a>  
            </div>
        </div>
		<script type="text/template" id="currentbwListTemplate">
        <table class="biaoge_ceng clearfix" cellspacing="0" cellpadding="0" id="oreredlist">
            <tr ><th class="tt1">设备</th><th class="tt2">MAC地址</th><th class="tt3">操作</th></tr>
			{{if(!it.data) { }}
        	   <tr><td colspan="3" style="text-align:center;color:#999999;">暂无设备</td></tr>
        	{{ }else { }}
			    {{ for (var i = 0,l = it.data.length;i < l;i++) { }}
				<tr>
					<td>{{=it.data[i].name}}</td>
					<td>{{=it.data[i].mac}}</td>
					<td><a href="##" class="del" data-query="{{=it.data[i].name}}|||{{=it.data[i].mac}}">删除</a></td>
				</tr>
			    {{ } }}
			{{ } }}
        </table>
		</script>
		<div id="bwCurrentList"></div>
    </div>  	
	<a href="##" class="bao_btn2" id="savebwlistbtn" style="display:none;">保存并生效</a>
    <div class="shengxiao_zhong">生效中...</div>
</div>  
<div class="footer"></div> 
<!-- 绑定MAC地址弹层-->
<div class="mac_layer" id="mac_layer">
    <a href="##" class="Close_layer"></a>
    <div class="conter_layer">
        <p>绑定MAC地址</p>
        <div class="layer_ip">
            <span class="layer_span">IP地址:</span>
            <strong class="layer_strong" id="bindipprevalue">192.168.1.</strong>
            <input type="text" id="bindipvalue" class="layer_input" maxlength="3"  
               onkeydown="if(event.keyCode==13)event.keyCode=9" onKeypress="if((event.keyCode<48 || event.keyCode>57)) event.returnValue=false"/>
			<div class="error-tip" style="margin-left:149px;margin-top:76px;width:110px;display:none;">请输入1~254的数字</div>
        </div>
        <div class="layer_mac">
            <span class="layer_spanmac">MAC地址:</span>
            <strong class="layer_mad" id="bindmacvalue">94:FB:B2:6C:27:4C</strong>
        </div>
        <div style="clear:both"></div>
        <div class="bangdi">
            <a href="##" class="bang_mac" id="bindmacbtn">绑定</a>
            <a href="##" class="bang_xiao">取消</a>
        </div>
    </div>
</div>

<!-- 浮层1开始-->
<div class="beg" id="beg">
   <a href="##" class="close_bi"></a>
   <div class="zhanghu">
    <strong>MAC地址绑定</strong>
   <p>绑定成功！</p>
   <p>设备新绑定的IP若与其当前IP不同，将在下次连接路由宝时生效。</p>
   </div>
   <a href="##" class="ok zhidao">我知道了</a>
</div>  
  <!-- 黑白名单说明弹层--> 
  
  <div class="shuoming_p" id="shuoming_p">
      <a href="##" class="cod"></a>
      <p class="ti_shi">提示</p>
      <p class="gouxuan">勾选列表中的无线设备，添加到黑名单或白名单，实现防蹭网效果</p>
 <p class="shi_mo">黑名单模式：禁止名单中的设备接入Wi-Fi</p>
  <p class="shi_mo2">白名单模式：只允许名单中的设备接入Wi-Fi</p>
  <a href="##" class="zhid_mo">我知道了</a>
  </div>
  <!-- 手动添加设备弹层-->
  <div class="mac_layer2" id="mac_layer2">
    <a href="##" class="Close_layer2"></a>
    <div class="conter_layer2">
        <p>手动添加设备</p>
        <div class="layer_ip2">
            <span class="layer_span2">设备名称:</span>
			<div class="error-tip" id="errorname" style="margin-left:52px;margin-top:79px;display:none;">最多可输入20个字符</div>
            <input type="text" id="addnamevalue" class="layer_input2" maxlength="25"> 
        </div>
    </div>
        <div class="layer_mac2">
            <span class="layer_spanmac2">MAC地址:</span>
            <input type="text" id="addmacvalue" class="layer_input2" maxlength="17"> 
			<div class="error-tip" id="errormac" style="margin-left:52px;margin-top:124px;width:145px;display:none;">MAC地址格式不正确</div>
        </div>
        <div style="clear:both"></div>
        <div class="bangdi2">
            <a href="##" class="bang_mac2" id="bindmacbtn">添加</a>
            <a href="##" class="bang_xiao2">取消</a>
        </div>
    </div> 
     <!-- 清空设备弹层-->  
     <div class="qing_kong" id="qing_kong">
         <a href="#" class="clera_btn"></a>
         <p class="she_bei">清空设备</p>
         <p class="quan_bu">你确定要清空列表中的全部设备吗</p>
         <div class="msh_btn">
             <a href="##" class="conndin">确定</a>
             <a href="##" class="qu_xiaobtn">取消</a>
         </div>
     </div>  

     <!-- 清空设备弹层-->  
     <div class="qing_kong" id="saveref">
         <a href="#" class="clera_btn"></a>
         <p class="she_bei">提示</p>
         <p class="quan_bu" id="saverefmsg1">切换模式时未保存的修改将会丢失，</p>
		 <p class="quan_bu" id="saverefmsg2">您确定要切换控制模式吗？</p>
         <div class="msh_btn">
             <a href="##" class="conndin">确定</a>
             <a href="##" class="qu_xiaobtn">取消</a>
         </div>
     </div>     	 
<script type="text/javascript">
$(document).ready(function() {
var currentbwlist={};
currentbwlist.data=[];
var oldblacklist=[];
var oldwhitelist=[];
var selectlist=[];
var currentdev="";
var currentdevname = "";
var currentbwmode="0";

$('.guan_close').on("click",function(){
	 var _this=$(this);
	if(_this.hasClass("closre")){
		_this.removeClass("closre");
		$(".cengwang").show();
		if($("#whitemoderadio").hasClass("radio")){
			currentbwmode="1";
		}else{
			currentbwmode="2";
		}
	}else{
		_this.addClass("closre"); 
        $(".cengwang").hide();
		currentbwmode="0";
	}
	$("#savebwlistbtn").show();
});


$('#addblackbtn').on("click",function(){
    var _this=$(this);
	if(!_this.hasClass("black_gray")){
	    _this.addClass("black_gray");
		
		if($('.guan_close').hasClass("closre")){
		    $('.guan_close').removeClass("closre");
		    $(".cengwang").show();
		}
		
	    if($("#whitemoderadio").hasClass("radio")){
		    oldwhitelist = $.extend(true,[],currentbwlist.data);
		    currentbwlist.data = $.extend(true,[],oldblacklist);
			$("#whitemoderadio").removeClass("radio");
			$("#blackmoderadio").addClass("radio");
		}
		
		if(!currentbwlist.data || currentbwlist.data.length < 1){
			currentbwlist.data = [];
		}

		for(i=0;i<selectlist.length;i++){
		   var metadata=selectlist[i];
		   var valueinfo=(metadata.split("|||"));
		   var item = {};
		   item.name = valueinfo[0];
		   item.mac = valueinfo[1];
		   var unexistflag = true;
		   for(j=0;j<currentbwlist.data.length;j++){
			   var itemData=currentbwlist.data[j];
			   if(item.mac.toUpperCase() == itemData.mac.toUpperCase()){
                   unexistflag = false;
				   break;
			   }
		   }
		   
		   if(unexistflag){
		       currentbwlist.data.push(item);
		   }
		}
		selectlist.splice(0,selectlist.length);
	    loadCurrentbwList(currentbwlist);
		$(".check_min").removeClass("check_min").addClass("check_ed");
		$("#savebwlistbtn").show();
		currentbwmode="2";
		$("#addblackbtn").addClass("black_gray");
		$("#addwhitebtn").addClass("black_gray");
	}
});

$('#addwhitebtn').on("click",function(){
    var _this=$(this);
	if(!_this.hasClass("black_gray")){
	    _this.addClass("black_gray");
		
		if($('.guan_close').hasClass("closre")){
		    $('.guan_close').removeClass("closre");
		    $(".cengwang").show();
		}
		
	    if($("#blackmoderadio").hasClass("radio")){
		    oldblacklist = $.extend(true,[],currentbwlist.data);
		    currentbwlist.data = $.extend(true,[],oldwhitelist);
			$("#blackmoderadio").removeClass("radio");
			$("#whitemoderadio").addClass("radio");
		}
		
		if(!currentbwlist.data || currentbwlist.data.length < 1){
			currentbwlist.data = [];
		}

		for(i=0;i<selectlist.length;i++){
		   var metadata=selectlist[i];
		   var valueinfo=(metadata.split("|||"));
		   var item = {};
		   item.name = valueinfo[0];
		   item.mac = valueinfo[1];
		   var unexistflag = true;
		   for(j=0;j<currentbwlist.data.length;j++){
			   var itemData=currentbwlist.data[j];
			   if(item.mac.toUpperCase() == itemData.mac.toUpperCase()){
                   unexistflag = false;
				   break;
			   }
		   }
		   
		   if(unexistflag){
		       currentbwlist.data.push(item);
		   }
		}
		selectlist.splice(0,selectlist.length);
	    loadCurrentbwList(currentbwlist);
		$(".check_min").removeClass("check_min").addClass("check_ed");
		$("#savebwlistbtn").show();
		_this.removeClass("black_gray");
		currentbwmode="1";
	}
});

$(".shoudong").on("click",function(e){
    var doflag = true;
	$("#errorname").hide();
	$("#errormac").hide();
	$(".error-tip").hide();
    popup.showId("mac_layer2",{layerCss:{position:"fixed",left:"50%",top:"50%",marginLeft:"-170px", marginTop:"-97px"
    },closeBtn:".Close_layer2",
	cancelBtn:".bang_xiao2",
    okBtn:".bang_mac2",
	okbtnmulticlick:true,
    okBtnClick:function(a,b){
	    if(doflag){
		    doflag = false;
			var namevalue = $("#addnamevalue").val();
			var macvalue = $("#addmacvalue").val();
			if(namevalue == ""){ 
			    $("#errorname").html("设备名称不能为空");
				$("#errorname").show();
				doflag = true;
				return;
			}
			
			if(namevalue.length > 20){ 
			    $("#errorname").html("最多可输入20个字符");
				$("#errorname").show();
				doflag = true;
				return;
			}
			
			if(macvalue == ""){ 
			    $("#errormac").html("设备MAC地址不能为空");
				$("#errormac").show();
				doflag = true;
				return;
			}
			
			var reg=/^[A-Fa-f\d]{2}(:)[A-Fa-f\d]{2}(:)[A-Fa-f\d]{2}(:)[A-Fa-f\d]{2}(:)[A-Fa-f\d]{2}(:)[A-Fa-f\d]{2}$/;
			if(!reg.test(macvalue)){ 
			    $("#errormac").html("设备MAC地址格式不正确");
				$("#errormac").show();
				doflag = true;
				return;
			}
			
			for(i=0;i<currentbwlist.data.length;i++){
			   var itemData=currentbwlist.data[i];
			   if(macvalue.toUpperCase() == itemData.mac.toUpperCase()){
			       $("#errormac").html("该设备已在列表中");
				   $("#errormac").show();
				   doflag = true;
				   return;
			   }
		    }
			
			var item = {};
			item.name = namevalue;
			item.mac = macvalue;
			if(!currentbwlist.data || currentbwlist.data.length < 1){
			    currentbwlist.data = [];
			}
			currentbwlist.data.push(item);
		    loadCurrentbwList(currentbwlist);
			popup.close(a,b,"hide");
			doflag = true;
		} 
    }                                     
  });
});
        
$(".ed").on("click",function(e){
    popup.showId("shuoming_p",{layerCss:{position:"fixed",left:"50%",top:"50%",marginLeft:"-220px",marginTop:"-148px"
    },closeBtn:".cod",
    okBtn:".zhid_mo",
    okBtnClick:function(a,b){
        popup.close(a,b,"hide");
    }                                     
  });
});   

$(".qingkong").on("click",function(e){
    popup.showId("qing_kong",{layerCss:{position:"fixed",left:"50%",top:"50%",marginLeft:"-170px",marginTop:"-100px"},
	closeBtn:".clera_btn",
	cancelBtn:".qu_xiaobtn",
    okBtn:".conndin",
    okBtnClick:function(a,b){
	   if(currentbwlist.data.length > 0){
	       currentbwlist.data.splice(0,currentbwlist.data.length);
	       loadCurrentbwList(currentbwlist);
	   }
       popup.close(a,b,"hide");
    }                                     
  });
}); 
function setbwradiomode(mode){
    if(mode=="black"){
	    $('#blackmoderadio').addClass("radio");
		$('#whitemoderadio').removeClass("radio");
		oldwhitelist = $.extend(true,[],currentbwlist.data);
	    currentbwlist.data = $.extend(true,[],oldblacklist);
		currentbwmode="2";
	}else{
	    $('#whitemoderadio').addClass("radio");
		$('#blackmoderadio').removeClass("radio");
		oldblacklist = $.extend(true,[],currentbwlist.data);
	    currentbwlist.data = $.extend(true,[],oldwhitelist);
		currentbwmode="1";
	}
	loadCurrentbwList(currentbwlist);
	$("#savebwlistbtn").show();
}  

$('#blackmoderadio').on("click",function(){
    var _this=$(this);
	if(!_this.hasClass("radio")){
	    setbwradiomode("black");
	}
});	

$('#whitemoderadio').on("click",function(){
    var _this=$(this);
	if(!_this.hasClass("radio")){
		 setbwradiomode("white");
	}
});	   
    
$("#devCurrentList").on("click",".check_ed",function(){
   var _this=$(this);
   if(_this.hasClass("check_min")){
      _this.removeClass("check_min");
	  selectlist.splice($.inArray(_this.attr("data-query"),selectlist),1);
	  if (selectlist.length < 1 ){
	      $('.hei span').addClass("black_gray");
	  }  
    }else{
      _this.addClass("check_min");
	  selectlist.push(_this.attr("data-query"));
	  $('.hei span').removeClass("black_gray");
   }	
});
checkcookie();
var devCurrentList=$("#devCurrentList");
var bwCurrentList=$("#bwCurrentList");

bwCurrentList.on("click",".del",function(){
    var _this=$(this);
	var dataQuery=_this.attr("data-query");
	var valueinfo=(dataQuery.split("|||"));
	var macvalue = valueinfo[1];
	for(i=0;i<currentbwlist.data.length;i++){
	   var itemData=currentbwlist.data[i];
	   if(macvalue.toUpperCase() == itemData.mac.toUpperCase()){
           currentbwlist.data.splice(i,1);
		   break;
	   }
	}
	loadCurrentbwList(currentbwlist);
});
devCurrentList.delegate('tr',"hover",function(){
    $(this).toggleClass("blue");
	var _this = $(this);
	if(_this.hasClass("blue") && _this.find(".accept").hasClass("closed")){
	   _this.find(".editname").show();
	   _this.find(".Unbundling").show();
	   _this.find(".Binding").show();
	}else{
	   _this.find(".editname").hide();
	   _this.find(".Unbundling").hide();
	   _this.find(".Binding").hide();
	   _this.find(".text_wenzi").show();
	   _this.find(".bian_ji").hide();
	   _this.find(".editok").hide();
	}
});

devCurrentList.delegate('.accept',"click",function(){
     var _this=$(this);
	 refreshline();
    if(_this.hasClass("guanbi")){
       _this.removeClass("guanbi").addClass("closed");
	   _this.parents("tr").removeClass("zhuihui_ash").addClass("Normal");
	   _this.parents("tr").find(".editname").show();
	   _this.parents("tr").find(".Unbundling").show();
	   _this.parents("tr").find(".Binding").show();
	   var dataQuery=_this.attr("data-query");
	   var valueinfo=(dataQuery.split("|||"));
	   setDevicedata("3",valueinfo[0],valueinfo[1],valueinfo[2],function(data){ });
	   
    }else{
       _this.removeClass("closed").addClass("guanbi"); 
       _this.parents("tr").removeClass("Normal").addClass("zhuihui_ash");
	   _this.parents("tr").find(".editname").hide();
	   _this.parents("tr").find(".Unbundling").hide();
	   _this.parents("tr").find(".Binding").hide();
	   var dataQuery=_this.attr("data-query");
	   var valueinfo=(dataQuery.split("|||"));
	   setDevicedata("4",valueinfo[0],valueinfo[1],valueinfo[2],function(data){ });
    }
});

devCurrentList.delegate('.editname',"click",function(){
     var _this=$(this);
	 var _td = _this.parents("td");
	 refreshline();
	 //_td.find(".bian_ji").val($.trim(_td.find(".text_wenzi").html()));
	 _this.hide();
	 _td.find(".text_wenzi").hide();
	 var bianji = _td.find(".bian_ji");
	 bianji.show();
	 var tval = bianji.val();
	 bianji.val("").focus().val(tval);
	 _td.find(".editok").show();
	 
});

function setDeviceName(_this){
	 var _td = _this.parents("td");
	 var namevalue = _td.find(".bian_ji").val();
	 if(namevalue.length > 20 || namevalue.length <= 0){
	     if(namevalue.length > 20){
		    _td.find(".feifazi").html("<i>最多可输入20个字符</i>");
		 }else{
		    _td.find(".feifazi").html("<i>字符为空,请输入名称</i>");
		 }
		 _td.find(".feifazi").show();
	 }else{
	     var dataQuery=_td.find(".editok").attr("data-query");
		 setDevicedata("5",namevalue,dataQuery,"",function(data){
		     if(data.result==0){
			     if (namevalue.length > 18){
					 namevalue=namevalue.substr(0,15) + "...";	
				 }
			     _td.find(".text_wenzi").html(namevalue);
				 
				 var tmpdata = _td.find(".bwcheckbox").attr("data-query");
				 var datainfo = tmpdata.split("|||");
				 datainfo[0] = namevalue;
				 _td.find(".bwcheckbox").attr("data-query",datainfo[0]+"|||"+datainfo[1]);
				 
				 _td.find(".text_wenzi").show();
				 _td.find(".editname").show();
				 _td.find(".feifazi").hide();
				 _td.find(".bian_ji").hide();
				 _td.find(".editok").hide();
			 }
		 });
	 }
}

devCurrentList.delegate('.bian_ji',"keypress",function(event){
    if(event.keyCode=="13"){
	    setDeviceName($(this));
	}
});

devCurrentList.delegate('.editok',"click",function(){
     setDeviceName($(this));
});

devCurrentList.delegate('.bian_ji',"click",function(){
    var _this=$(this);
	var _td = _this.parents("td");
	$(".feifazi").hide();
});

$("#bindipvalue").on("click",function(){
	$(".error-tip").hide();
});
$("#addnamevalue").on("click",function(){
	$(".error-tip").hide();
});

$("#addmacvalue").on("click",function(){
	$(".error-tip").hide();
});

$("#devCurrentList").on("click",".Unbundling",function(){
	 refreshline();
	 $(".error-tip").hide();
	 var _this=$(this);
	 var curtd = _this.parents("td");
	 var dataQuery=_this.attr("data-query");
	 var valueinfo=(dataQuery.split("|||"));
	 var ipprev = valueinfo[2].split(".");
	 $("#bindipprevalue").html(ipprev[0]+"."+ipprev[1]+"."+ipprev[2]+".");
	 $("#bindipvalue").val(ipprev[3]);
	 $("#bindmacvalue").html(valueinfo[1]);
	 var setname = valueinfo[0];
	 var doflag = true;
	 
     popup.showId("mac_layer",{layerCss:{
        position:"fixed",left:"50%",top:"50%", marginLeft:"-170px", marginTop:"-116px"},
	    closeBtn:".Close_layer",
		okbtnmulticlick:true,
       okBtn:".bang_mac",
	   cancelBtn:".bang_xiao",
	   okBtnClick:function(a,b){
	       if(doflag){
		       doflag = false;
			   var namevalue = $("#bindipvalue").val();
			   var re = /^\d+$/;
			   if(namevalue == "" || parseInt(namevalue) < 1 
				  || parseInt(namevalue) > 254 || !re.test(namevalue)){ 
				   $(".error-tip").show();
			   }else{
				 var setip=$.trim($("#bindipprevalue").html())+$.trim($("#bindipvalue").val()); 
				 var setmac=$("#bindmacvalue").html();
				 var setValue=setname+"|||"+setmac+"|||"+setip;
				 setDevicedata("2","",setmac,setip,function(data){
				  if(data.result==0){
					curtd.html('<div class="ip_configure"><div class="ip_Address">'+valueinfo[2]+'</div>'+
						 '<div class="Mac_Address"><div class="mac_Name">'+setmac+'</div>'+
						 '<div class="Binding"><span class="Already">已绑定</span>'+
						 '<a href="##" class="Relieve" data-query="'+dataQuery+'">解除</a></div>');
					curtd.parents("tr").removeClass("blue");
					popup.hide(a,b,"hide");
				    popup.showId("beg",{layerCss:{position:"fixed",left:"50%",top:"50%", marginLeft:"-220px",marginTop:"-101px"},
							   closeBtn:".close_bi",okBnt:".ok",okBtnClick:function(a,b){popup.close(a,b,"hide"); }  });
				  }else{
				    popup.hide(a,b,"hide");
				    popup.simpleBox({
					  title:"提示",
					  hideCancel:0,
					  content:data.error.desc,
					  okBtnClick:function(layer,overlay){
						 popup.close(layer,overlay);
					  }
			        });
				  }
				});
			  }
			  doflag = true;
		  }
	   }                                     
	});
});

devCurrentList.delegate('.Relieve',"click",function(){
    refreshline();
    var _this=$(this);
	var _td = _this.parents("td");
	var dataQuery=_this.attr("data-query");
	var valueinfo=(dataQuery.split("|||"));
	setDevicedata("1",valueinfo[0],valueinfo[1],valueinfo[2],function(data){
	    if(data.result==0){
		    _td.html('<div class="ip_configure"><div class="ip_Address">'+valueinfo[2]+'</div>'+
                     '<div class="Mac_Address"><div class="mac_Name">'+valueinfo[1]+'</div>'+
                     '<div class="mac_Modify"><div class="Unbundling" id="Unbundling" data-query="'+dataQuery+'">MAC地址绑定</div>'+
                     '</div></div></div>');
			_td.parents("tr").removeClass("blue");
	    }	
	});
});

function refreshline(){
    $(".text_wenzi").show();
	$(".editname").hide();
	$(".bian_ji").hide();
	$(".editok").hide();
	$(".feifazi").hide();
};

function setDevicedata(op,name,mac,ip,callback){
   var setParam = {};
   setParam.devices = [];
   var itemData = {};
   itemData.device_op = op
   itemData.device_name = urlencode(name);
   itemData.device_mac = mac;
   itemData.device_ip = ip;
   setParam.devices.push(itemData);
   $.getJSON(baseUrl,{op:"set",
    context:createSetContext(setParam),
    key:$.cookie("key")},
    function(data){ 
       checkresult(data);
       callback(data); 
    });
}

$("#savebwlistbtn").on("click",function(){
    if(currentbwmode != "0" && currentdev != ""){
	    //check list
		var foundflag=false;
		var curindex = 0;
		for(j=0;j<currentbwlist.data.length;j++){
		   var itemData=currentbwlist.data[j];
		   if(currentdev.toUpperCase() == itemData.mac.toUpperCase()){
			   foundflag = true;
			   curindex = j;
			   break;
		   }
	   }
	   
	   if(currentbwmode=="1" && !foundflag){
	       $("#saverefmsg1").html("您当前本机设备应加入白名单，否则无法");
		   $("#saverefmsg2").html("连接路由宝Wi-Fi，点击确定将自动加入");
	       popup.showId("saveref",{layerCss:{position:"fixed",left:"50%",top:"50%",marginLeft:"-170px",marginTop:"-100px"},
			   closeBtn:".clera_btn",
			   cancelBtn:".qu_xiaobtn",
			   okBtn:".conndin",
			   okBtnClick:function(a,b){
					 var item = {};
					 item.name = currentdevname;
					 item.mac = currentdev;
					 if(!currentbwlist.data || currentbwlist.data.length < 1){
						currentbwlist.data = [];
					 }
					 currentbwlist.data.push(item);
					 loadCurrentbwList(currentbwlist);
					 setbwlistinfo();
					 popup.close(a,b,"hide");
			   }                                     
	       });	
	   }else if(currentbwmode=="2" && foundflag){
	       $("#saverefmsg1").html("您当前本机设备不应加入黑名单，否则无法");
		   $("#saverefmsg2").html("连接路由宝Wi-Fi，点击确定将自动删除");
	       popup.showId("saveref",{layerCss:{position:"fixed",left:"50%",top:"50%",marginLeft:"-170px",marginTop:"-100px"},
			   closeBtn:".clera_btn",
			   cancelBtn:".qu_xiaobtn",
			   okBtn:".conndin",
			   okBtnClick:function(a,b){
					 currentbwlist.data.splice(curindex,1);
	                 loadCurrentbwList(currentbwlist);
					 setbwlistinfo();
					 popup.close(a,b,"hide");
			   }                                     
	       });	
	   }else{
	       setbwlistinfo();
	   }    
	}else{
	    setbwlistinfo();
	}
});

function setbwlistinfo(){
    var setParam = {};
	var submitBtn=$("#savebwlistbtn");
	$("#savebwlistbtn").hide();
	$(".shengxiao_zhong").show();
	popup.showOpaLay();
	
	setParam.blackwhitemode = currentbwmode;
	if(currentbwmode=="1"){
	    oldwhitelist = $.extend(true,[],currentbwlist.data);
	}else if(currentbwmode=="2"){
	    oldblacklist = $.extend(true,[],currentbwlist.data);
	}else{
	    if($("#whitemoderadio").hasClass("radio")){
			oldwhitelist = $.extend(true,[],currentbwlist.data);
		}else{
			oldblacklist = $.extend(true,[],currentbwlist.data);
		}
	}
	
	setParam.blackdevlist = [];
	for(i=0;i<oldblacklist.length;i++){
	  var itemData=oldblacklist[i];
	  itemData["name"]=urlencode(itemData["name"]);
	  setParam.blackdevlist.push(itemData);
	}
	
	setParam.whitedevlist = [];
	for(i=0;i<oldwhitelist.length;i++){
	  var itemData=oldwhitelist[i];
	  itemData["name"]=urlencode(itemData["name"]);
	  setParam.whitedevlist.push(itemData);
	}
	
	$.getJSON(baseUrl,{op:"set",context:createSetContext(setParam),key:$.cookie("key")},
		function (data) {
		checkresult(data);
		if(data.result==0 && data.data.mode==0){
			popup.tip("设置成功！");
			
		}else{
			popup.simpleBox({
			  title:"提示",
			  hideCancel:0,
			  content:data.error.desc,
			  okBtnClick:function(layer,overlay){
				 popup.close(layer);
			  }
			});
		}  
        $("#savebwlistbtn").show();
	    $(".shengxiao_zhong").hide();
		for(i=0;i<oldblacklist.length;i++){
		  var itemData=oldblacklist[i];
		  itemData["name"]=urldecode(itemData["name"]);
		}
	
		for(i=0;i<oldwhitelist.length;i++){
		  var itemData=oldwhitelist[i];
		  itemData["name"]=urldecode(itemData["name"]);
		}
        popup.hideOpaLay();		
	});
}

$(".refresh").on("click",function(){
    refreshAllList();
});

refreshAllList();
//获取刷新当前的设备列表
function refreshAllList(){
    $("#devConnNowNum").text(""); 
    $("#devConnNowRef").hide(); 
	$("#devConnNowRef1").show();
    $(".refresh").addClass("refresh_loading");
	popup.showOpaLay();
		$.getJSON(baseUrl,{op:"get",
                context:createContext("all"),
	            key:$.cookie("key")},
		function(data){
		   checkresult(data);
		   var devicelist=data.data.devices;
		   if(devicelist && devicelist.length==0) return;
		  //连接的设备数目
		  $("#devConnNowNum").text(devicelist.length); 
		  $("#devConnNowRef").html("台设备已连接路由宝"); 
		  $("#devConnNowRef").show(); 
	      $("#devConnNowRef1").hide();
		  $(".hei").show();
		  var currentDevData={};
		  currentDevData.data=[];
		  var remotemac = data.data.wan.remotemac;
		  for(i=0;i<devicelist.length;i++){
			 var itemData=devicelist[i];
			 itemData["up_rate"]=parseFloat(itemData["up_rate"]).toFixed(2);
			 itemData["down_rate"]=parseFloat(itemData["down_rate"]).toFixed(2);
			 itemData["name"]=urldecode(itemData["name"]);
			 if(itemData["name"]=="none"){
			     itemData["name"] = itemData["mac"].toUpperCase();
			 }
			 
			 if(remotemac && (remotemac.toUpperCase() == itemData["mac"].toUpperCase())
			    && itemData["contype"]=="wifi"){
			     currentdev = remotemac.toUpperCase();
				 currentdevname = itemData["name"];
			 }
			 
			 itemData["aliname"] = itemData["name"];
			 if (itemData["aliname"].length > 18){
			     itemData["aliname"]=itemData["aliname"].substr(0,15) + "...";	
			 }
             currentDevData.data.push(itemData);
		  }
		  
		  if(data.data.blackwhitemode){
		      oldblacklist = [];
			  for(i=0;i<data.data.blacklist.length;i++){
			      var itemData=data.data.blacklist[i];
				  itemData["name"]=urldecode(itemData["name"]);
				  oldblacklist.push(itemData);
			  }
			  
			  oldwhitelist = [];
			  for(i=0;i<data.data.whitelist.length;i++){
			      var itemData=data.data.whitelist[i];
				  itemData["name"]=urldecode(itemData["name"]);
				  oldwhitelist.push(itemData);
			  }
			  
			  if(data.data.blackwhitemode=="0"){
			      $('.guan_close').addClass("closre"); 
                  $("#cengwangPanel").hide();
				  currentbwlist.data = $.extend(true,[],oldblacklist);
				  currentbwmode="0";
			  
			  }else if(data.data.blackwhitemode=="1"){
			      $('.guan_close').removeClass("closre");
		          $("#cengwangPanel").show();
				  $("#whitemoderadio").addClass("radio");
				  $("#blackmoderadio").removeClass("radio"); 
				  currentbwmode="1";
				  currentbwlist.data = $.extend(true,[],oldwhitelist);
				  $("#savebwlistbtn").show();
				  
			  }else{
			      $('.guan_close').removeClass("closre");
		          $("#cengwangPanel").show();
				  $("#whitemoderadio").removeClass("radio");
				  $("#blackmoderadio").addClass("radio"); 
				  currentbwmode="2";
				  currentbwlist.data = $.extend(true,[],oldblacklist);
				  $("#savebwlistbtn").show();
			  }
		  }
		  
		  loadCurrentDevList(currentDevData);
		  loadCurrentbwList(currentbwlist);
		  $("#youkuversion").html(data.data.curver);
		  $("#wanmac").html(data.data.MacAddr);
		  $("#wanIP").html(data.data.wanIP);
		  $(".refresh").removeClass("refresh_loading");
		  $(".editname").hide();
		  $(".Unbundling").hide();
	      $(".Binding").hide();
		  $(".fangceng").show();
		  popup.hideOpaLay();	
		});
}
	
//渲染设备列表
function loadCurrentDevList(data){
	if(data.data && data.data.length==0) data.data=false;
	 var tmpl=document.getElementById('currentDevListTemplate').innerHTML;
	 var doTtmpl = doT.template(tmpl)(data);
	 devCurrentList.html(doTtmpl);
}

//渲染黑白名单
function loadCurrentbwList(data){
	if(data.data && data.data.length==0) {
	    data.data=false;
		$(".qingkong").hide();
	}else{
	    $(".qingkong").show();
	}
	var tmpl=document.getElementById('currentbwListTemplate').innerHTML;
	var doTtmpl = doT.template(tmpl)(data);
	bwCurrentList.html(doTtmpl);
}

$("#logoutbtn").on("click",function(){ weblogout();});
});
</script>
</body>
</html>
