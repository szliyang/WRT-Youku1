<!doctype html>
<html>
<head>
<meta charset="utf-8">
<title>优酷土豆路由宝</title>
<link rel="stylesheet" type="text/css" href="css/popup.css?ver=20160121">
<link rel="stylesheet" type="text/css" href="css/widget.css?ver=20160121">
<link rel="stylesheet" type="text/css" href="css/networkset.css?ver=20160121">
<link rel="stylesheet" type="text/css" href="css/System.css?ver=20160121">
<link rel="stylesheet" type="text/css" href="css/upgrade.css?ver=20160121">
<link rel="stylesheet" type="text/css" href="extend/css/hefot.css?ver=20160121">
<script type="text/javascript" charset="utf-8"  src="js/jquery.min.js?ver=20160121"></script>
<script type="text/javascript" charset="utf-8"  src="js/jquery.form.js?ver=20160121"></script>
<script type="text/javascript" charset="utf-8"  src="js/jquery.base64.js?ver=20160121"></script>
<script type="text/javascript" charset="utf-8"  src="js/jquery.cookie.js?ver=20160121"></script>
<script type="text/javascript" charset="utf-8"  src="js/jquery.tabs.js?ver=20160121"></script>
<script type="text/javascript" charset="utf-8"  src="js/public.js?ver=20160121"></script>
<script type="text/javascript" charset="utf-8"  src="js/json2.js?ver=20160121"></script>
<script type="text/javascript" charset="utf-8"  src="js/validate.js?ver=20160121"></script>
<script type="text/javascript" charset="utf-8"  src="js/nodeClick.js?ver=20160121"></script>
<script type="text/javascript" charset="utf-8"  src="js/popup.js?ver=20160121"></script>
<script type="text/javascript" charset="utf-8"  src="extend/js/common.js?ver=20160121"></script>
<script src="js/jquery.tabs.js?ver=20160121"></script>
<script type="text/javascript" charset="utf-8"  src="js/upgrade.js?ver=20160121"></script>

</head>
<body>
<div class="header_body" style="min-width: 1250px;">
    <div class="logo"></div>
    <div class="nav">
		<ul class="nav_top" id="topmenu">
			<li><a href="##" dataurl="dashboard.html" class="topmenu">首页</a></li>
			<li><a href="##" dataurl="wan.html" class="topmenu">连网设置</a></li>
			<li><a href="##" dataurl="wireless.html" class="topmenu">Wi-Fi设置</a></li>
			<li><a href="##" dataurl="device.html" class="topmenu">设备管理</a></li>
			<li class="current"><a href="##" dataurl="advanced_setting.html" class="topmenu current">更多设置</a></li>
       	</ul>
    </div>
    <div class="nav_right"></div>
</div>
<div class="nav-con">
	<ul class="nav-lists clearfix">
        <li ><a href="##" dataurl="advanced_setting.html" class="topmenu">高级设置</a></li>
        <li class="current"><a href="##" dataurl='upgrade.html' class="topmenu current">系统升级</a></li>
        <li><a href="##" dataurl='password.html' class="topmenu">管理密码</a></li>
        <li class="lisd "><a href="##" dataurl='reboot_reset.html' class="topmenu">重启与恢复</a></li>
    </ul>
    </div>
   	<div class="box box_top">
	<ul class="tab_menu">
		<li class="current leftindex" data-index=""><a href="###">升级检查</a></li>
		<li class="leftindex" data-index=""><a href="###">手动升级</a></li>
		<li class="leftindex" data-index="autoupgrade"><a href="###">自动升级</a></li>
	</ul>
	<iframe name="iframeUpload" id="iframeUpload" style="display:none"></iframe>
	<div class="tab_box">
		<div class="tab_guan indexpage">
			<div class="neiwang">当前版本：<span id="versionNow"></span></div>
		   	<div class="jiancexin" id="checkIng">
		       	<img src="images/loading.gif">
		       	<p>正在检测更新...</p>
		   	</div>
		   	<div class="zuixinban" id="checkResult">
		       	<img src="images/ji.png">
		       	<p>您的系统已经是最新版，无需更新！</p>
		       	<a href="##" class="chongxinjian" id="resetCheck">重新检测</a>
		   	</div>
		    <div class="wendingban" id="currentVer">
		       	<img src="images/ji.png">
		       	<p>检测到新版本：<span id="ver-now"></span><span id="update-size"></span></p>
		       	<dl>
		           	<p class="tp1">更新内容：</p>
                   	<ul id="updatereference" style="width:450px;margin-left:10px;"><li></li></ul>
		       	</dl>
		        <a href="##" class="chongxinjian" id="atOnceUpate">立即升级</a>
		   	</div>
		</div>
		<div class="neiwang_fu hide indexpage" id="manualUpdate">
		    <div class="neiwang">手动上传升级包</div>
			<form name="uploadForm" id="uploadForm" method="post" enctype="multipart/form-data" >
		    <div class="xuanze">
		        <p>当前版本：<span id="versionNow2"></span></p>
				<div class="error-tip" style="margin-top:318px;margin-left:593px;width:300px;display:none;" id="errtip"></div>				
		        <div class="new-contentarea tc">
	                <a href="javascript:void(0)" class="upload-img">
					    <label for="image">上传文件</label>
	                    <input type="file" class="" name="image" id="image" />
					</a>
					<img id="tmpimg" dynsrc="" src="" style="display:none"/>
                </div>
		    </div>
			</form>
		</div>
		<div class="autoUpgrade hide indexpage" id="">
			<div class="neiwang">自动升级设置</div>
			<div class="auContent">
			    <div class="switch">
		     		<span class="guanbi switchStyle"></span>
				</div>
				<div class="au_remind" style="">路由宝将在夜间空闲状态时自动升级到最新版</div>
				<a class="saveAUBut">保 存</a>
			</div>
			<div class="loadingDiv">
		       	<img src="images/loading.gif">
		       	<p>正在保存...</p>
		   	</div>
		</div>
	</div>
    </div>
<div class="footer"></div> 
<!-- 正在升级弹窗开始-->
<div class="shengjitanceng" id="shengjitanceng">
    <p>正在升级...</p>
    <div class="graph"> 
        <strong id="bar"></strong>
    </div>
    <div class="zhengzaishengji">请勿中断连接，也不要断电，以免损坏路由宝。</div>
</div>
<!-- 正在升级弹窗结束-->

<!-- 升级完成弹窗开始-->
<div class="shenhjiwan" id="onlineOKbox">
    <a href="##" class="guan_bt close"></a>
    <span></span>
    <p>升级完成！您的系统已经是最新版！</p>
    <a  href="##" class="wozhidao ok" >我知道了</a >
</div>

<!-- 升级完成弹窗结束-->

<!-- 升级包不合格开始-->
<div class="buhegebao" id="onlineerrbox">
   <p id="online_error">升级包未通过验证，无法升级！</p>
   <a href="##" class="lijishengji ok">确定</a>
</div>
<!-- 升级包不合格结束-->

<!-- 正在上传升级包开始-->
<div class="shangchuanbao" id="uploadbox">
    <p id="uploadRef">正在上传升级包...</p>
   <div class="graph"> 
        <strong id="bar2"></strong> 
    </div>
    <div class="shanchu">
        <span id="uploadfilename">youkudfdggdd2.23.1.acf </span>
    </div>
</div>

<!-- 正在上传升级包结束-->

<!-- 升级包合格开始-->
<div class="hegebao" id="hegebao">
   <p>升级包已通过验证，请点击下方按钮开始升级。</p>
   <a href="##" class="lijishengji ok" id="hegebao_btn">立即升级</a>
</div>
<!-- 升级包合格结束-->

<!-- 升级包不合格开始-->
<div class="buhegebao" id="buhegebao">
   <p>升级包未通过验证，无法升级！</p>
   <span id="uploadfilename2">youkudfdggdd2.23.1.acf</span>
   <a href="##" class="lijishengji ok" id="buhegebao_btn">删除升级包并取消升级</a>
</div>
<!-- 升级包不合格结束-->
<script type="text/javascript">
$('.box').Tabs({event:'click',callback:null});
checkcookie();

var tmpstr = window.location.href;
if(tmpstr.match("autoupgrade")){
	$(".tab_menu").find(".leftindex").removeClass("current");
	$(".tab_menu").find('li[data-index="autoupgrade"]').addClass("current");
	var currIndex = $(".tab_menu").find('li[data-index="autoupgrade"]').index();
	$(".tab_box").find(".indexpage").eq(currIndex).removeClass("hide").siblings().removeClass("hide").addClass("hide");
}

$('.switchStyle').on("click",function(){
	var _this = $(this);
	if(_this.hasClass("guanbi")){
		_this.removeClass("guanbi");
	}else{
		_this.addClass("guanbi");
	}
});

setLightPanel($(".biaozhun"));
function setLightPanel(p){
 var lc=p.find(".biao_left");
 var rc=p.find(".biao_right");
 lc.on("click",function(){
   $(this).addClass("biao_left_hei");
   rc.removeClass("acti_biao_tnu");
   $(".quantian").show();
   $(".yejian").hide();
 });
 rc.on("click",function(){
  $(this).addClass("acti_biao_tnu");
   lc.removeClass("biao_left_hei");
   $(".quantian").hide();
  $(".yejian").show();
 });
}

var commonPid = "";//pid

$.getJSON(baseUrl,
    {op:"get",
     context:createContext("network"),
	 key:$.cookie("key")},
    function(data){
	   checkresult(data);
	   if(data.result==0){
		  $("#youkuversion").html(data.data.curver);
		  $("#wanmac").html(data.data.MacAddr);
		  $("#wanIP").html(data.data.wanIP);
		  commonPid = data.data.crypid;
		  getIsAuto(data.data.crypid);
	}
});

/**检查是否自动更新**/
function getIsAuto(_pid){
	$.ajax({
		url: "http://pcdnapi.youku.com/pcdn/update/config?pid="+urlencode(_pid),
		dataType: 'jsonp', 
		timeout: 10000,
		success: function(json){
			checkresult(json);
			if (json.code == 0) {
				var switchAuto = json.data.auto;
				if (switchAuto == 1) {
					$(".autoUpgrade").find(".switchStyle").removeClass("guanbi");
					$(".autoUpgrade").find(".au_remind").html("路由宝将在夜间空闲状态时自动升级到最新版");
				}else{
					$(".autoUpgrade").find(".switchStyle").removeClass("guanbi").addClass("guanbi");
					$(".autoUpgrade").find(".au_remind").html("开启后，路由宝将在夜间空闲状态时自动升级到最新版");
				}
			}
		}
	});
}

/**保存是否自动更新**/
$(".autoUpgrade").on("click",".saveAUBut",function(){
	changeAUStyle("loading");
	var switchVal = $(".autoUpgrade").find(".switchStyle").hasClass("guanbi") ? 0 : 1;
	$.ajax({
		url: "http://pcdnapi.youku.com/pcdn/update/config?pid="+urlencode(commonPid)+"&auto="+urlencode(switchVal),
		dataType: 'jsonp', 
		timeout: 10000,
		success: function(json){
			changeAUStyle("result");
			checkresult(json);
			if (json.code == 0) {
				popup.tip("设置成功！");
				if (json.data.auto == 1) {
					$(".autoUpgrade").find(".switchStyle").removeClass("guanbi");
					$(".autoUpgrade").find(".au_remind").html("路由宝将在夜间空闲状态时自动升级到最新版");
				}else{
					$(".autoUpgrade").find(".switchStyle").removeClass("guanbi").addClass("guanbi");
					$(".autoUpgrade").find(".au_remind").html("开启后，路由宝将在夜间空闲状态时自动升级到最新版");
				}
				
			}else{
				popup.tip("设置失败！");
			}
		},error:function(){
			popup.tip("设置失败！");
			changeAUStyle("result");
		}
	});
});

/**loading显示**/
function changeAUStyle(style){
	if (style == "loading") {
		$(".autoUpgrade").find(".auContent").hide();
		$(".autoUpgrade").find(".loadingDiv").show();
	}else if(style == "result"){
		$(".autoUpgrade").find(".auContent").show();
		$(".autoUpgrade").find(".loadingDiv").hide();
	}
	
}

function checkupdateCurr(){
  $("#checkIng").show();
  $("#currentVer").hide(); 
  $("#checkResult").hide();
  $.getJSON(baseUrl,{op:"upgrade",context:createContext("check"),key:$.cookie("key")}, 
       function(data){
	    checkresult(data);
		var hasupdate = data.data["hasupdate"];
		if (hasupdate == "1"){
			$("#ver-now").html(data.data["newver"]);
			$("#update-size").html("("+data.data["size"]+")");
			var ref = data.data["descforweb"];
			if (ref != ""){
				 $("#updatereference").html('<li>' + ref + '</li>');
			}
			$("#currentVer").show(); 
			$("#checkResult").hide();				
			
		}else{
			$("#checkResult").show(); 
			$("#currentVer").hide();				
		}
		$("#versionNow").html(data.data["curver"]);
		$("#versionNow2").html(data.data["curver"]);
		$("#checkIng").hide();       
  });
}

  var timer=null;
  var upgradeflag = false;
  var progressupnum = 0;
  checkupdateCurr();
  
  $('#resetCheck').on('click',function(){
	checkupdateCurr();
  });
  
  $('#atOnceUpate').on('click',function(){
    updateBoxdoing();
  	$.getJSON(baseUrl, {op:"upgrade", context:createContext("start"), key:$.cookie("key")},
	    function(data){
		    checkresult(data);
	       if (data['result'] == "0"){
	       	  window.setTimeout(function(){getprocess();},500);
	       }    
	  });
  });
  
  function updateBoxdoing(){
      popup.showId("shengjitanceng",{layerCss:{
	  position:"fixed",left:"50%", top:"50%", marginLeft:"-220px", marginTop:"-101px"},
	   closeBtn:".close" });
	   $("#bar").css("width","0%");
	   $("#bar").animate({width:"100%"},480000,'linear',function(){
			popup.hide($("#shengjitanceng"),"","hide");
			popup.showId("onlineOKbox",{layerCss:{
				  position:"fixed",left:"50%", top:"50%", marginLeft:"-220px", marginTop:"-101px"},
				  closeBtn:".close",okBnt:".ok",
				  okBtnClick:function(a,b){
					  popup.close(a,b,"hide");
				  } 
			});	
	  });
  }
  
  var updateokflag = true;
  var timeout;
  
  function getprocess(){
  	$.getJSON(baseUrl, {op:"upgrade", context:createContext("progress"), key:$.cookie("key")},
  	    function(data){ 
		   checkresult(data);
  		   if (data.result == "0"){
		     var persent = data.data['persent']; 
  		   	 if (parseInt(persent) == 100 && updateokflag){
			    updateokflag = false;
				getprocess();
				timeout = setTimeout(function(){cycleChackState(5000);},200000);
			 }else{
			    getprocess();
			 } 
  		   }else{
			 if(data.result == "10032"){
			     $("#online_error").html("下载失败，请重新检测升级版本！")
			 }else{
				 $("#online_error").html("更新失败，请稍后重新检测升级版本！") 
			 }
			 $("#bar").stop();
			 if(timeout){
			    clearTimeout(timeout);
			 }
			 updateokflag = true;
			 popup.hide($("#shengjitanceng"),"","hide");
			 popup.showId("onlineerrbox",{layerCss:{
				  position:"fixed",left:"50%", top:"50%", marginLeft:"-220px", marginTop:"-101px"},
				  closeBtn:".close",okBnt:".ok",
				  okBtnClick:function(a,b){
					  popup.close(a,b,"hide");
				  } 
			 });
		   }
	  });
  }
  
  //上传文件
  $.fn.ajaxUpload = function(options){
	var iframeContents;

	var form = $(this);
	form.attr("action", options.url);
	form.attr("method", "post");
	form.attr("enctype", "multipart/form-data");
	form.attr("encoding", "multipart/form-data");
	form.attr("target", "iframeUpload");
	form.submit();

	$(document.getElementById("iframeUpload"))
		.load(function () {
			iframeContents = document.getElementById("iframeUpload").contentWindow.document.body.innerHTML;
			var rsp = iframeContents.match(/^\{.*?\}/);
			rsp = $.parseJSON(rsp[0]);
			options.success(rsp);
		})
		.error(function(){
			options.error();
		});
	return false;
  };

  //点击按钮上传
  $('#image').change(function(){
	var image = $('#image');
	var err = $('#errtip');
	if (image.val() == '') {
		err.html('您未选择文件，请选择升级包文件。').show();
		return false;
	}
	var val = image.val();
	var ext = val.substring(val.lastIndexOf('.') + 1);
	ext = $.trim(ext);
	var validExt = ext == 'bin' || ext == 'BIN';
	if (!validExt) {
		err.html('升级包文件格式错误，请选择正确的升级包。').show();
		return false;
	}
	
	var  browserCfg = {};
    var ua = window.navigator.userAgent;
    if (ua.indexOf("MSIE")>=1){
       browserCfg.ie = true;
    }else if(ua.indexOf("Firefox")>=1){
       browserCfg.firefox = true;
    }else if(ua.indexOf("Chrome")>=1){
       browserCfg.chrome = true;
    }
	
	var obj_file = document.getElementById('image');
	var filesize = 0;
    if(browserCfg.firefox || browserCfg.chrome ){
      filesize = obj_file.files[0].size;
    }else if(browserCfg.ie){
      var obj_img = document.getElementById('tmpimg');
      obj_img.src=obj_file.value;
      filesize = obj_img.fileSize;
    }
	
	if(filesize > 12*1024*1024){
	    err.html('升级包错误，请选择正确的升级包。').show();
		return false;
	}
	
	err.hide();
	var options = {
		type: 'post',
		dataType:"json",
		url: baseUrl+"op=upload&context="+escape(createContext("firmware"))+"&key="+$.cookie("key"),
		uploadProgress:function(event, position, total, percentComplete){
		    $("#bar2").css("width", percentComplete+"%");
		},
		success: function(rsp) {
			if (rsp.result == 0) {
			    $("#bar2").css("width", "100%");
				checkuploadimage();
			}else{
				err.html('上传升级包出错，请重试。').show();
				err.show();
				popup.close($("#uploadbox"),$("#YKRouterOverLayId"),"hide");
			}
		},
		error: function(data) {
		    if (data && data.status == 403){ window.location.href="login.html";}
			err.html('系统错误，可能您上传的文件不正确，请重试。').show();
			err.show();
			popup.close($("#uploadbox"),$("#YKRouterOverLayId"),"hide");
		}
	};
	
	var binfilename = val.substring(val.lastIndexOf('\\') + 1);
	if(binfilename.length > 20)
	{
		binfilename = binfilename.substr(0,18) + "...";			    
	}
	$("#uploadfilename").html(binfilename);
	$("#uploadfilename2").html(binfilename);
	$("#uploadRef").html("正在上传升级包...");
     popup.showId("uploadbox",{layerCss:{
		  position:"fixed",left:"50%", top:"50%", marginLeft:"-220px", marginTop:"-101px"},
		  closeBtn:".close"
	});
	$('#uploadForm').ajaxSubmit(options);
	image.val('');
	return false;
  });
  
  function checkuploadimage(){
	   $("#uploadRef").html("正在验证升级包...");
	   $.getJSON(baseUrl, {op:"upgrade", context:createContext("checkimage"), key:$.cookie("key")},
  	    function(data){ 
		    checkresult(data);
		    popup.hide($("#uploadbox"),"","hide");
  		    if(data && data.result==0){
			    popup.showId("hegebao",{layerCss:{
				  position:"fixed",left:"50%", top:"50%", marginLeft:"-220px", marginTop:"-101px"},
				  closeBtn:".close",okBnt:".ok",
				  okBtnClick:function(a,b){
					  popup.hide(a,b,"hide");
					  updateBoxdoing();
					  $.getJSON(baseUrl, {op:"upgrade", context:createContext("start"), key:$.cookie("key")});
					  setTimeout(function(){cycleChackState(5000);},200000);
				  } 
			    });
			}else{
			    popup.showId("buhegebao",{layerCss:{
				  position:"fixed",left:"50%", top:"50%", marginLeft:"-220px", marginTop:"-101px"},
				  closeBtn:".close",okBnt:".ok",
				  okBtnClick:function(a,b){
					  popup.close(a,b,"hide");
					  $.getJSON(baseUrl, {op:"manage", context:createContext("clearfirmware"), key:$.cookie("key")});
				  } 
			    });
			}
	   });
  }
  
  $("#logoutbtn").on("click",function(){ weblogout();});
  
</script>

</body>
</html>
