<!doctype html>
<html>
<head>
<meta charset="utf-8">
<title>优酷土豆路由宝</title>
<link rel="stylesheet" type="text/css" href="css/reset.css?ver=20160121">
<link rel="stylesheet" type="text/css" href="css/popup.css?ver=20160121">
<link rel="stylesheet" type="text/css" href="css/tab.css?ver=20160121">
<link rel="stylesheet" type="text/css" href="css/widget.css?ver=20160121">
<link rel="stylesheet" type="text/css" href="css/networkset.css?ver=20160121">
<link rel="stylesheet" type="text/css" href="extend/css/hefot.css?ver=20160121">
<script type="text/javascript" charset="utf-8"  src="js/jquery.min.js?ver=20160121"></script>
<script type="text/javascript" charset="utf-8"  src="js/jquery.base64.js?ver=20160121"></script>
<script type="text/javascript" charset="utf-8"  src="js/jquery.cookie.js?ver=20160121"></script>
<script type="text/javascript" charset="utf-8"  src="js/jquery.tabs.js?ver=20160121"></script>
<script type="text/javascript" charset="utf-8"  src="js/public.js?ver=20160121"></script>
<script type="text/javascript" charset="utf-8"  src="js/json2.js?ver=20160121"></script>
<script type="text/javascript" charset="utf-8"  src="js/validate.js?ver=20160121"></script>
<script type="text/javascript" charset="utf-8"  src="js/nodeClick.js?ver=20160121"></script>
<script type="text/javascript" charset="utf-8"  src="js/popup.js?ver=20160121"></script>
<script type="text/javascript" charset="utf-8"  src="extend/js/common.js?ver=20160121"></script>
<script type="text/javascript" charset="utf-8"  src="js/upgrade.js?ver=20160121"></script>
</head>
<body>
<div class="header_body" style="min-width: 1250px;">
    <div class="logo"></div>
    <div class="nav">
       <ul class="nav_top" id="topmenu">
        <li><a href="##" dataurl="dashboard.html" class="topmenu">首页</a></li>
        <li class="current"><a href="##" dataurl="wan.html" class="topmenu current">连网设置</a></li>
        <li><a href="##" dataurl="wireless.html" class="topmenu">Wi-Fi设置</a></li>
        <li><a href="##" dataurl="device.html" class="topmenu">设备管理</a></li>
        <li><a href="##" dataurl="advanced_setting.html" class="topmenu">更多设置</a></li>
       </ul>
    </div>
    <div class="nav_right"></div>
</div>
    <div class="header clearfix">
        <div class="line">
            <p>设置路由宝连网方式</p>
        </div>

        <form class="comn-form" id="GuestModeForm">
         <div class="pppoe-state">
            <span class="user-tip2" id="pppoeStateNotice">已连网</span>
            <a href="###" id="disConnectBtn" style="display:none;">断开</a>
        </div>
        <div class="select_tie  clearfix">
        <div class="item" style="margin-left:-29px;">
            <label class="outset-label">连网类型 :</label>
			<div class="select-overlay" id="disableSelectConnType" style="display:none;"></div>
            <div id="divselect" class="divselect">
              <span class="label">动态IP</span>
              <ul class="list">
                 <li><a href="javascript:;" selectid="1" data-panel="mima">宽带拨号</a></li>
                 <li><a href="javascript:;" selectid="2" data-panel="select-panel">动态IP</a></li>
                 <li><a href="javascript:;" selectid="3" data-panel="jingtai_yincang">静态IP</a></li>
              </ul>
          </div>
        </div>
        
       <div class="mima net-panel" style="margin-left:-29px;">
            <div class="select-panel clearfix">
            <label class="outset-label" for="netUser">宽带账号 :</label>
			<span class="lianwang-holder">请输入宽带账号</span>
            <input type="text" id="netUser" class="comn-input g" data-rules="required" data-required-error="宽带账号不能为空">
            <a href="##" class="item-in"  id="helpNetAcc"></a>
			<div class="error-tip" style="margin-left:11px;top:-33px;display:none;"></div>
        </div>
         <div class="select-panel">
            <label class="outset-label" for="netUser">宽带密码 :</label>
            <span class="lianwang-holder">请输入宽带密码</span>
            <input type="password" id="netPass"  class="comn-input g" data-rules="required"  data-required-error="宽带密码不能为空">
            <a href="##" class="item-in" id="helpNetAcc2"></a>
			<div class="error-tip" style="margin-left:11px;top:-33px;display:none;"></div>
        </div>
       </div>
       <div class="jingtai_yincang net-panel " style="margin-left:-29px;">
            <div class="select-panel clearfix">
            <label class="outset-labelme" for="netUser">IP地址 :</label>
			<span class="lianwang-holder">请输入IP地址</span>
            <input type="text" id="ipaddr" class="comn-input g" data-rules="required|ip"  data-required-error="IP地址不能为空" data-ip-error="IP地址格式不正确">
			<div class="error-tip" style="margin-left:11px;top:-33px;display:none;"></div>
        </div>
         <div class="select-panel clearfix" >
            <label class="outset-label" for="netUser">子网掩码 :</label>
			<span class="lianwang-holder">请输入子网掩码</span>
            <input type="text" id="netCKMask" class="comn-input g" data-rules="required|mask"  data-required-error="子网掩码不能为空" data-mask-error="子网掩码格式不正确">
			<div class="error-tip" style="margin-left:11px;top:-33px;display:none;"></div>
        </div>
         <div class="select-panel clearfix">
            <label class="outset-label" for="netUser">默认网关 :</label>
			<span class="lianwang-holder">请输入默认网关</span>
            <input type="text" id="netGateWay" class="comn-input g" data-rules="required|ip"  data-required-error="网关地址不能为空" data-ip-error="网关地址格式不正确">
			<div class="error-tip" style="margin-left:11px;top:-33px;display:none;"></div>
        </div>
       </div>
        <div class="sets">
<!--             <a href="##" ></a> -->
            <strong class="advSetBut">高级设置<img alt="" src="images/xiala-right.png" class="setImg"></strong>
            
        </div>
        <div class="kelong kelong_hidden">
           <label class="outset-label" style="">MAC地址克隆操作 :</label>
            <div id="divselect2" class="divselect divselect222">
              <span class="label">使用出厂MAC地址</span>
              <ul class="list">
<!--                  <li><a selectid="1" data-panel="当前路由的MAC地址 :" data-value="">不克隆MAC地址</a></li> -->
<!--                  <li><a selectid="2" data-panel="当前设备的MAC地址 :" data-value="">克隆当前设备的MAC地址</a></li> -->
<!--                  <li><a selectid="3" data-panel="路由出厂的MAC地址 :" data-value="">使用路由出厂MAC地址</a></li> -->
<!--                  <li><a selectid="4" data-panel="手动输入的MAC地址 :" data-value="">手动输入MAC地址</a></li> -->
                 <li><a selectid="3" data-panel="使用出厂MAC地址 :" data-value="">使用出厂MAC地址</a></li>
                 <li><a selectid="1" data-panel="使用当前MAC地址 :" data-value="">使用当前MAC地址</a></li>
                 <li><a selectid="2" data-panel="克隆为当前管理设备MAC地址 :" data-value="">克隆为当前管理设备MAC地址</a></li>
                 <li><a selectid="4" data-panel="手动输入MAC地址:" data-value="">手动输入MAC地址</a></li>
              </ul>
          </div>
        <span class="shuoming"></span>
        <div class="select-pane">
            <label class="outset-label" for="netUser" id="WancurMacLabel">MAC地址 :</label>
            <input type="text" value="" class="comn-input" id="WaninputMacVal" data-rules="required|mac" data-required-error="MAC地址不能为空" data-mac-error="MAC地址格式不正确" disabled>
			<div class="error-tip" style="margin-left:75px;top:-33px;display:none;"></div>
        </div>
        <div class="zidingyi">
            <label class="outset-labere" for="netUser">自定义DNS:</label>
            <span class="guanbi" style="float:left;"></span>
            <span class="text" id="dnsreference">DNS用于解析网站，通常网络运营商会帮我们解析，建议关闭。</span>
            <div class="shouxuan">
                <div class="select-pane">
                    <label class="outset-label outset-label_p" for="netUser">首选DNS :</label>
					<span class="lianwang-holder">请输入首选DNS</span>
                    <input type="text" value="" class="comn-input" id="firstDNS" data-ip-error="DNS地址格式不正确" data-required-error="首选DNS地址不能为空" data-rules="required|ip">
					<div class="error-tip" style="margin-left:11px;top:-33px;display:none;"></div>
                </div>
                <div class="select-pane">
                    <label class="outset-label outset-label_p" for="netUser">备用DNS（选填）:</label>
					<span class="lianwang-holder">请输入备用DNS</span>
                    <input type="text" value="" class="comn-input" id="spareDNS" data-rules="ip" data-ip-error="DNS地址格式不正确">
					<div class="error-tip" style="margin-left:11px;top:-33px;display:none;"></div>
                </div>
            </div>
        </div>
        </div>
            <div class="baocun save-btn" id="saveSetConnMode">保 存</div>
        </div>
    </form>
	
	<form class="comn-form hidden_form" id="GuestModeForm2">
         <div class="pppoe-state">
            <span class="user-tip5">未连网，WAN口未插入网线。</span>
        </div>
        <div class="select_tie select_tie2 clearfix">
        <div class="item item2">
            <label class="outset-label">连网类型 :</label>
            <div class="divselect">
			  <span class="label" style="border:1px #eeeeee solid;color:#eee;">宽带拨号</span>
              <ul class="list">
                 <li><a href="javascript:;" selectid="1">宽带拨号</a></li>
                 <li><a href="javascript:;" selectid="2">动态IP</a></li>
                 <li><a href="javascript:;" selectid="3">静态IP</a></li>
              </ul>
          </div>
        </div>
        <div class="select-panel">
            <label class="outset-label" for="netUser">宽带账号 :</label>
            <input type="text" disabled="disabled" style="background:#fff;border:1px #eeeeee solid" class="comn-input">
            <span class="item-in2"></span>
        </div>
         <div class="select-panel">
            <label class="outset-label" for="netUser">宽带密码 :</label>
            <input  type="text" disabled="disabled" style="background:#fff;border:1px #eeeeee solid" class="comn-input">
            <span class="item-in2"></span>
        </div>
        <div class="sets sets3">
            <span class="sets2"></span>
            <strong>高级设置</strong>
        </div>
      
            <span class="baocun_p ">保 存</span>
        </div>
     </form>
</div>
       <!-- 浮层1开始-->
       <div class="beg" id="beg">
           <a href="##" class="close_bi"></a>
           <div class="zhanghu">
               <strong>提示</strong>
           <p>账号和密码在网络运营商提供给您的开户卡片或开户单上。</p>
           </div>
           <a href="##" class="ok zhidao">我知道了</a>
       </div>
     <!-- 浮层1结束-->
      <!-- 浮层2开始-->
       <div class="fuceng" id="beg2">
           <span class="tipd"></span>
           <div class="kuandai">
               <strong>提示</strong>
               <p class="hao">请找出记录账号和密码的开户卡片或开户单。
或打客服电话咨询：</p>
          <div class="ci">
              <p>中国电信&nbsp;&nbsp;10000</p>
              <p class="dan">中国联通&nbsp;&nbsp;10010 </p>
			  <p>中国移动&nbsp;&nbsp;10086</p>
              <p class="dan">长城宽带&nbsp;&nbsp;96090090</p>
              <p>宽&nbsp;&nbsp;带&nbsp;&nbsp;通&nbsp;&nbsp;96007</p>
              <p class="dan">铁通宽带&nbsp;&nbsp;10050</p>
			  <p>歌华宽带&nbsp;&nbsp;96196</p>
              <p class="dan">方正宽带&nbsp;&nbsp;010-82529990</p>
          </div>
           </div>
           <a href="##" class="zhidao ok">我知道了</a>
       </div>
    <div class="macbang" id="macbang">
        <a href="##" class="close_bnt"></a>
        <h2>提示</h2>
        <p>
            使用该功能会更改路由器WAN接口的MAC地址，
			以满足某些连网环境的特定要求，请谨慎操作，
			或咨询网络管理员或宽带运营商。
        </p>
        <div style="clear:both"></div>
        <a href="##" class="zhi_dao">我知道了</a>
    </div>
	
	<div class="macbang" id="restartnetwork">
        <a href="##" class="close_bnt"></a>
        <h2>提示</h2>
		<p id="setsuccessful">设置成功！</p>
        <p>路由宝已重启网络服务，请重新连接WiFi...<a href="##" id="TheWifiName3" style="color:#60be06;"></a></p>
        <div style="clear:both"></div>
        <a href="##" class="zhi_dao">我知道了</a>
    </div>
<div class="footer"></div>   
<script>
$(".shuoming").on("click",function(e){
	popup.showId("macbang",{layerCss:{
    	position:"fixed",
        left:"50%",
        top:"50%",
        marginLeft:"-220px",
        marginTop:"-121px"
	},closeBtn:".close_bnt",
        okBtn:".zhi_dao",
        okBtnClick:function(a,b){
         	popup.close(a,b,"hide");
        }                                     
    });
});
checkcookie();
var divselect=$("#divselect");
var divselect2=$("#divselect2");
var wanprotovalue="1";
var wanmacvalue="1";
var connectiontype = "line";

divselect.find(".label").on("click",function(e){
	var optList=divselect.find(".list");
	if(optList.is(":visible")){
		$(this).removeClass("open");
		optList.hide();
	}else{
		$(this).addClass("open");
		optList.show(); 
	}
	e.stopPropagation();
});

divselect2.find(".label").on("click",function(e){
	var optList=divselect2.find(".list");
	if(optList.is(":visible")){
		$(this).removeClass("open");
		optList.hide();
	}else{
		$(this).addClass("open");
		optList.show(); 
	}
	e.stopPropagation();
});
		 
divselect.on("click","[data-panel]",function(e){
	divselect.find(".label").text($(this).text());
	divselect.find(".list").hide();
	$("div.net-panel").hide();
	divselect.find(".label").removeClass("open");
	$("div."+$(this).attr("data-panel")).show();
	wanprotovalue = $(this).attr("selectid");
	if (wanprotovalue=="3"){
	    $(".sets>a").addClass("dianji");
	    $(".setImg").hide();
		$('.kelong').removeClass("kelong_hidden");
		$('#dnsreference').html("使用静态IP连网方式时，必须设置DNS，否则会导致无法上网。");
	    $('.zidingyi').show();
	    $(".shouxuan").show();
	    $('.guanbi').addClass("closed").hide();
	}else{
	    $(".sets").show();
	    $(".setImg").show();
		$('#dnsreference').html("DNS用于解析网站，通常网络运营商会帮我们解析，建议关闭。");
		$('.guanbi').removeClass("closed").show();
	    $(".shouxuan").hide();
	}
	e.stopPropagation();
});

divselect2.on("click","[data-panel]",function(e){
	divselect2.find(".label").text($(this).text());
	divselect2.find(".list").hide();
	divselect2.find(".label").removeClass("open");
	if ($(this).attr("data-value") != "") {
		$("#WaninputMacVal").attr("disabled",true);
	}else{
		$("#WaninputMacVal").attr("disabled",false);
	}
	$("#WaninputMacVal").val($(this).attr("data-value"));
	wanmacvalue = $(this).attr("selectid");
	e.stopPropagation();
});

var itemInputs=$(".comn-input");
 itemInputs.on("focus",function(){
	 $(this).prev(".lianwang-holder").hide();
 }).on('blur',function(){
	 val=$(this).val();
	 if(!val){
		 $(this).prev(".lianwang-holder").show();
	 }
 });
 
 $(".lianwang-holder").on("click",function(){
	$(this).hide();
	$(this).next().focus();
 });

$(document.body).on("click",function(e){
	divselect.find(".list").hide();
	divselect2.find(".list").hide();
});

function setDivselect(index){
    var selecteditem = divselect.find("a[selectid="+index+"]");
	wanprotovalue = selecteditem.attr("selectid");
    divselect.find(".label").text(selecteditem.text());
	divselect.find(".list").hide();
	$("div.net-panel").hide();
	divselect.find(".label").removeClass("open")
	$("div."+selecteditem.attr("data-panel")).show();
	if (wanprotovalue=="3"){
	    $(".sets>a").addClass("dianji");
	    $(".setImg").hide();
		$('.kelong').removeClass("kelong_hidden");
		$('#dnsreference').html("设置静态IP模式时，必须设置DNS，否则会导致无法上网。");
	    $('.zidingyi').show();
	    $(".shouxuan").show();
		$('.guanbi').addClass("closed").hide();
	}else{
	    $(".sets").show();
	    $(".setImg").show();
		$('#dnsreference').html("DNS用于解析网站，通常网络运营商会帮我们解析，建议关闭。");
		$('.guanbi').removeClass("closed").show();
	    $(".shouxuan").hide();
	}
};
				  
$("#GuestModeForm").find(".advSetBut").on("click",function(){
	var _this=$(this);
	if(wanprotovalue != "3"){
		if(_this.hasClass("dianji")){
			_this.removeClass("dianji");
			$(this).find(".setImg").attr("src","images/xiala-right.png");
			$('.kelong').addClass("kelong_hidden");
			$('.guanbi').removeClass("closed");
		    $(".shouxuan").hide();
		}else{
			$(this).find(".setImg").attr("src","images/xiala.png");
			_this.addClass("dianji");
			$('.kelong').removeClass("kelong_hidden");
		}
	}
});
		  
$('.guanbi').on("click",function(){
	 var _this=$(this);
	if(_this.hasClass("closed")){
		_this.removeClass("closed");
		$(".shouxuan").hide();
	}else{
		_this.addClass("closed");   
		$(".shouxuan").show();
	}
});

$("#helpNetAcc").on("click",function(e){
	popup.showId("beg",{layerCss:{position:"fixed",left:"50%",top:"50%", marginLeft:"-220px",marginTop:"-101px"},
	closeBtn:".close_bi",okBnt:".ok",okBtnClick:function(a,b){popup.close(a,b,"hide"); }  });
});

$("#helpNetAcc2").on("click",function(e){
	popup.showId("beg2",{layerCss:{position:"fixed",left:"50%",top:"50%", marginLeft:"-177px", marginTop:"-160px"},
	closeBtn:".tipd",okBnt:".ok",okBtnClick:function(a,b){ popup.close(a,b,"hide");}   });
});

$("#spareDNS").addRule('sparedns',function(){
    var _this=$(this),val=_this.val();
    if(!val) return true;
  　var reg=/^(\d{1,2}|1\d\d|2[0-4]\d|25[0-5])\.(\d{1,2}|1\d\d|2[0-4]\d|25[0-5])\.(\d{1,2}|1\d\d|2[0-4]\d|25[0-5])\.(\d{1,2}|1\d\d|2[0-4]\d|25[0-5])$/;
    return val && reg.test(val);　
});
			
var pppoeStateNotice=$("#pppoeStateNotice");
var saveSetConnMode=$("#saveSetConnMode");
var pppoeConnStatus=["正在连接互联网…","已连网","未连网，WAN口已插入网线。"];
var pppoeTimer=null;
var pppoeRequestAjax=null;
var pppoeConnDelay=1000;
var disConnectBtn=$("#disConnectBtn");
var currentPPPOEState=null;
var disableSelectConnType=$("#disableSelectConnType");
var pppoetimeoutflag=0;
var contipflag=false;		
var innerNetBaseSet={};	
var user_waiting = false;	

popup.showOpaLay();
function checkwanconnect(){
    $.getJSON(baseUrl,{op:"get",context:createContext("network"),key:$.cookie("key")},
	function(data){
	   	checkresult(data);
	   	if(data.result==0){
	      	if(data.data && data.data.wanstate){
	      		var wanclone = wanmacvalue = data.data.wan.wanclone;
	      		
	      		if (wanclone == "1") {
	      			$("#WaninputMacVal").val(data.data.wan.localmac);
				}else if(wanclone == "2"){
					$("#WaninputMacVal").val(data.data.wan.remotemac);
				}else if(wanclone == "3"){
					$("#WaninputMacVal").val(data.data.wan.initmac);
				}else if (wanclone == "4") {
					$("#WaninputMacVal").val(data.data.wan.localmac);
				}
	      		var currCloneText = $("#divselect2").find("a[selectid="+wanclone+"]").text();
	      		$("#divselect2").find(".label").text(currCloneText);
	      		
		      	var wanstate = data.data.wanstate;
		      	if(wanstate=="0"){
			      	$("#GuestModeForm").addClass("hidden_form");
				  	$("#GuestModeForm2").removeClass("hidden_form");
				  	$("#youkuversion").html(data.data.curver);
				  	$("#wanmac").html(data.data.MacAddr);
                  	$("#wanIP").html(data.data.wanIP);
				  	window.setTimeout(function(){checkwanconnect();},2000);	
			  	}else{
			      	$("#GuestModeForm2").addClass("hidden_form");
				  	$("#GuestModeForm").removeClass("hidden_form");
				  	getwandata(data);
			  	}
		  	}
	   	}
	   	popup.hideOpaLay();	
	});
}

function getwandata(data){
    if(data.data && data.data.wan){
		if(data.data.wan.proto=='pppoe'){
		  setDivselect(1);
		  pppoetimeoutflag=0;
		}else if(data.data.wan.proto=='static'){
		  setDivselect(3);
		  pppoeStateNotice.removeClass("user-tip3").addClass("user-tip2");
		  pppoeStateNotice.html("已连网");
		  disConnectBtn.hide();
		}else{
		  setDivselect(2);
		  pppoeStateNotice.removeClass("user-tip3").addClass("user-tip2");
		  pppoeStateNotice.html("已连网");
		  disConnectBtn.hide();
		}				
		
		if(data.data.wan.username && data.data.wan.username != ""){
			 $('#netUser').attr('value', data.data.wan.username);
			 $('#netPass').attr('value', data.data.wan.password);
		}
		$('#ipaddr').attr('value', data.data.wan.ipaddr);
		$('#netCKMask').attr('value', data.data.wan.netmask);
		$('#netGateWay').attr('value', data.data.wan.gateway);
		
		var wanstate = data.data.wanstate;
		if(wanstate == "1"){
			pppoeStateNotice.removeClass("user-tip2").addClass("user-tip3");
			pppoeStateNotice.html(pppoeConnStatus[2]);
		}
		divselect2.find("a[selectid=1]").attr('data-value', data.data.wan.localmac);
		divselect2.find("a[selectid=2]").attr('data-value', data.data.wan.remotemac);
		divselect2.find("a[selectid=3]").attr('data-value', data.data.wan.initmac);
		$("#WaninputMacVal").val(data.data.wan.localmac);
		
		if(data.data.wan["switch"] && data.data.wan["switch"] == "1"){
			$('.guanbi').addClass("closed");  
			$("#GuestModeForm").find(".sets>a").addClass("dianji");	
			$('.kelong').removeClass("kelong_hidden");					
			$(".shouxuan").show();
			$("#firstDNS").val(data.data.wan.dns1);
			$("#spareDNS").val(data.data.wan.dns2);
		}else{
			$("#GuestModeForm").find(".sets>a").removeClass("dianji");
			$('.kelong').addClass("kelong_hidden");
			$('.guanbi').removeClass("closed");
			$(".shouxuan").hide();
		}
		
		if(data.data.wan.proto=='static'){
		  setDivselect(3);
		}
		
    }
  $("#youkuversion").html(data.data.curver);
  $("#wanmac").html(data.data.MacAddr);
  $("#wanIP").html(data.data.wanIP);
  
  connectiontype = data.data.connectiontype;
  $("#TheWifiName3").html(data.data.wifi.name);
  $(".comn-input").prev(".lianwang-holder").show();
  $(".comn-input").each(function(){
	  if($(this).val().length > 0){
		  $(this).prev(".lianwang-holder").hide();
	  }
  });
}

checkwanconnect();

//开始不断获取pppoe的状态和结束拨号
 function startWatchPPPOE(){
  clearInterval(pppoeTimer);
  pppoeTimer=setInterval(function(){watchWideBandState();},pppoeConnDelay);
 }
 function stopWatchPPPOE(){
  clearInterval(pppoeTimer);
  pppoeTimer=null;
  pppoeRequestAjax && pppoeRequestAjax.abort(); 　
  formSaveBtnState.resetInit(saveSetConnMode);
 }

//断开拨号
disConnectBtn.on("click",function(){
  disableSelectConnType.hide();
  $(this).hide();
  user_waiting = false;
  stopWatchPPPOE();
  $.getJSON(baseUrl,{op:"pppoestop",key:$.cookie("key")},
  function(data){
     checkresult(data);
	if(currentPPPOEState==2){
	   contipflag=false;
	   startWatchPPPOE();
	   pppoetimeoutflag=0;
	}else {
	 pppoeStateNotice.removeClass("user-tip2").addClass("user-tip3");
	 pppoeStateNotice.html(pppoeConnStatus[2]);
	} 
  });
});

//联网方式表单验证
 validate($("#GuestModeForm"),{
   ignore:":hidden .comn-input",
   valiBreak:true,//每次只验证一个,
   autoReset:true,
   submitHandler:function(){
	 submitConnType();
   }
 });
	
//监视宽带连接状态
function watchWideBandState(){
      pppoeRequestAjax=$.getJSON(baseUrl,{op:"get",context:createContext("pppoestate"),key:$.cookie("key")},
	  function(data){
	    checkresult(data);
        if(!data.data || !data.data.pppoestate) return false;
        if(data.data.pppoestate=="0"){
           disableSelectConnType.hide();
		   pppoeStateNotice.removeClass("user-tip2").addClass("user-tip3");
           pppoeStateNotice.html(pppoeConnStatus[2]);
           disConnectBtn.hide();
		   stopWatchPPPOE();
        }else if(data.data.pppoestate=="1"){
         disableSelectConnType.show();
		 pppoeStateNotice.removeClass("user-tip2").addClass("user-tip3");
         pppoeStateNotice.html(pppoeConnStatus[0]);
         formSaveBtnState.loading(saveSetConnMode,"拨号中...");
		 disConnectBtn.hide();
		 pppoetimeoutflag++;
		 if(pppoetimeoutflag == 15){
			stopWatchPPPOE();
			disableSelectConnType.hide();
			pppoeStateNotice.removeClass("user-tip2").addClass("user-tip3");
			pppoeStateNotice.html("拨号超时，请重新连接");
			popup.simpleBox({
			  content:'拨号超时，请重新连接！',
			  hideCancel:true,
			  okBtnName:"确定",
			  okBtnClick:function(layer,overlay){popup.close(layer,overlay,"hide");}
			});
		 }
        }else if(data.data.pppoestate=="2"){
         disableSelectConnType.hide();
		 pppoeStateNotice.removeClass("user-tip3").addClass("user-tip2");
         pppoeStateNotice.html(pppoeConnStatus[1]);
         //disConnectBtn.show();
         currentPPPOEState=2;
		 pppoetimeoutflag=0;
		 stopWatchPPPOE();
		 if(contipflag){
		     popup.tip("设置成功！");
			 contipflag=false;
		 }
        }else if(data.data.pppoestate=="3"){
         disableSelectConnType.hide();
		 stopWatchPPPOE();
		 pppoeStateNotice.removeClass("user-tip2").addClass("user-tip3");
         pppoeStateNotice.html("返回码:"+data.data.pppoeerrcode+"&nbsp;&nbsp;&nbsp;描述:"+data.data.pppoeerrmsg);
		 popup.simpleBox({
          content:'账号或密码错误，拨号失败！',
          hideCancel:true,
          okBtnName:"确定",
          okBtnClick:function(layer,overlay){
            popup.close(layer,overlay,"hide");
			}
		});
		 disConnectBtn.hide();
        }else if(data.data.pppoestate=="4"){
	        if( user_waiting == false )
		      {
                 disableSelectConnType.hide();
				 pppoeStateNotice.removeClass("user-tip2").addClass("user-tip3");
		         pppoeStateNotice.html(pppoeConnStatus[2]);
		         disConnectBtn.hide();
				 stopWatchPPPOE(); 
		      }
		    else
		      {//用户等待中
                disableSelectConnType.show();
				pppoeStateNotice.removeClass("user-tip2").addClass("user-tip3");
		      	pppoeStateNotice.html(pppoeConnStatus[0]);
         		formSaveBtnState.loading(saveSetConnMode,"拨号中...");
				disConnectBtn.hide();
				pppoetimeoutflag++;
				 if(pppoetimeoutflag == 15){
					stopWatchPPPOE();
					disableSelectConnType.hide();
					pppoeStateNotice.removeClass("user-tip2").addClass("user-tip3");
					pppoeStateNotice.html("拨号超时，请重新连接");
					popup.simpleBox({
					  content:'拨号超时，请重新连接！',
					  hideCancel:true,
					  okBtnName:"确定",
					  okBtnClick:function(layer,overlay){popup.close(layer,overlay,"hide");}
					});
				 }
		      }
        }   
      });  
    }
	
function restart_net_service(conType, requestObj) {
		 var setParam = {};
		 setParam.wan = requestObj;
         $.getJSON(baseUrl,{op:"set",context:createSetContext(setParam),key:$.cookie("key")},
             function (retdata) {
			     checkresult(retdata);
                 var checkfinish = function () {
                     $.getJSON(baseUrl,{op:"get",context:createContext("actionstate"),key:$.cookie("key")},
                         function (data) {
                             if (data.data.actionstate == 'finish') {
								 user_waiting = true;
								 contipflag=true;
								 startWatchPPPOE();
								 pppoetimeoutflag=0;
                             } else {
                                 window.setTimeout(checkfinish, 1000);
                             }
                         }
                      );
                 };
				 
				 var networkrestart = function(callback){
				    var timer=null,delay=10000;
			        $("#youkuloadingbtn").html("已生效正在重启网络..."+Math.ceil(delay/1000)+"秒");
			        if(timer) clearInterval(timer);
			        timer=setInterval(function(){
					if(delay<=0){
						clearInterval(timer);
						timer=null;
						if(connectiontype!="line"){
						    if(conType == "pppoe"){
							    $("#setsuccessful").hide();
							}else{
							    $("#setsuccessful").show();
							}
							popup.showId("restartnetwork",{layerCss:{ position:"fixed",left:"50%",top:"50%", marginLeft:"-220px", marginTop:"-121px"},
							closeBtn:".close_bnt",okBtn:".zhi_dao",okBtnClick:function(a,b){
								  popup.close(a,b,"hide");
								  callback();
							} });
						}else{
						    callback();
						}
					}else{
						delay-=1000;
						$("#youkuloadingbtn").html("已生效正在重启网络..."+Math.ceil(delay/1000)+"秒");	
					} 
				    },1000);	
				 }
				 
				 if(conType == "pppoe"){
				     if(retdata.data && retdata.data.mode!=0){
				        networkrestart(checkfinish);
					 }else{
					    checkfinish();
					 }
				 }else{
				     if(retdata.data && retdata.data.mode!=0){
					    networkrestart(function(){
						    formSaveBtnState.resetInit(saveSetConnMode);
							pppoeStateNotice.removeClass("user-tip3").addClass("user-tip2");
						    pppoeStateNotice.html("已连网");
							if(connectiontype=="line"){
						        popup.tip("设置成功！");
							}
						});
					 }else{
					    formSaveBtnState.resetInit(saveSetConnMode);
						pppoeStateNotice.removeClass("user-tip3").addClass("user-tip2");
						pppoeStateNotice.html("已连网");
						popup.tip("设置成功！");
					 }
				 }  
             }
         );
     }
	 
  //提交联网方式设置
  function submitConnType(){
     var requestObj = {};
	 formSaveBtnState.resetInit(saveSetConnMode);
     if(wanprotovalue=="1"){
      formSaveBtnState.loading(saveSetConnMode,"拨号中...");
      disableSelectConnType.show();
       requestObj.proto = "pppoe";
       requestObj.wan_username = $("#netUser").val();
       requestObj.wan_password = $("#netPass").val();
     }else if(wanprotovalue=="2"){
        formSaveBtnState.loading(saveSetConnMode,"正在生效...");
        requestObj.proto = 'dhcp';
     }else if(wanprotovalue=="3"){
        formSaveBtnState.loading(saveSetConnMode,"正在生效...");
        requestObj.proto = 'static';
        requestObj.wan_ipaddr = $("#ipaddr").val();
        requestObj.wan_netmask = $("#netCKMask").val();
        requestObj.wan_gateway = $("#netGateWay").val();
     }
	 
	 if(!$('.kelong').hasClass("kelong_hidden")){
	    if(wanmacvalue=="2"){
			requestObj.wan_mac=$("#WaninputMacVal").val();
		}else if(wanmacvalue=="4"){
			requestObj.wan_mac=$("#WaninputMacVal").val();
		}else if(wanmacvalue=="1"){
			requestObj.wan_mac="notclone";
		}else {
			requestObj.wan_mac="default";
		}
	    requestObj.wanclone = wanmacvalue;
	 
	    if($('.guanbi').hasClass("closed") || wanprotovalue=="3"){
		    requestObj.dns_switch = "1";
		    requestObj.dns1 = $("#firstDNS").val();		
			requestObj.dns2 = $("#spareDNS").val();
		}else{
		    requestObj.dns_switch = "0";
		}
	}
	if(requestObj.proto != null)
        restart_net_service(requestObj.proto, requestObj);
  }
  
  $("#logoutbtn").on("click",function(){ weblogout();});
</script>
</body>
</html>
